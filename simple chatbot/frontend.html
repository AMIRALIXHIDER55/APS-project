<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>چت‌بات ساده</title>
  <style>
    * { box-sizing: border-box; font-family: Tahoma, sans-serif; }
    html,body { height:100%; margin:0; padding:0; background:#f0f2f5; direction:rtl; }
    .wrap { min-height:100%; display:flex; justify-content:center; align-items:center; }
    .chat-container {
      width:400px; height:600px; background:#fff; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .chat-header { background:#4A90E2; color:#fff; padding:14px; text-align:center; font-size:18px; }
    .chat-messages { flex:1; padding:12px; overflow:auto; background:#fafafa; display:flex; flex-direction:column; gap:8px; }
    .message { max-width:80%; padding:10px 12px; border-radius:10px; word-break:break-word; }
    .user-message { align-self:flex-end; background:#DCF8C6; }
    .bot-message { align-self:flex-start; background:#e4e6eb; }
    .system-note { text-align:center; color:#666; font-size:13px; margin:6px 0; }
    .chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid #e6e6e6; background:#fff; }
    .chat-input input {
      flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:6px; outline:none; font-size:14px;
    }
    .chat-input button {
      padding:10px 14px; border-radius:6px; border:none; background:#4A90E2; color:#fff; cursor:pointer;
    }
    .chat-input button[disabled] { opacity:0.6; cursor:not-allowed; }
    .loading-dot { display:inline-block; width:6px; height:6px; margin:0 2px; border-radius:50%; background:#666; opacity:0.2; animation:blink 1s infinite; }
    @keyframes blink { 0%{opacity:0.2} 50%{opacity:1} 100%{opacity:0.2} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chat-container" role="application" aria-label="چت‌بات">
      <div class="chat-header">چت‌بات ساده</div>

      <div class="chat-messages" id="chatMessages" aria-live="polite"></div>

      <div class="chat-input" aria-hidden="false">
        <input id="userInput" type="text" autocomplete="off" placeholder="پیام خود را وارد کنید..." aria-label="متن پیام">
        <button id="sendBtn">ارسال</button>
      </div>
    </div>
  </div>

  <script>
    // ---- عناصر DOM ----
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // ---- کمک‌کننده‌ها ----
    function createMessage(content, isUser=false) {
      const el = document.createElement('div');
      el.className = 'message ' + (isUser ? 'user-message' : 'bot-message');
      el.textContent = content;
      return el;
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function setLoadingState(loading) {
      sendBtn.disabled = loading;
      if (loading) {
        sendBtn.textContent = 'در حال ارسال';
      } else {
        sendBtn.textContent = 'ارسال';
      }
    }

    // ---- افزودن پیام به صفحه ----
    function appendMessage(text, isUser=false) {
      // متن خالی را نادیده بگیر
      if (text === null || text === undefined) return;
      const msg = createMessage(text, isUser);
      chatMessages.appendChild(msg);
      scrollToBottom();
      return msg;
    }

    // ---- ارسال پیام به بک‌اند ----
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // پیام کاربر را نمایش بده
      appendMessage(text, true);
      userInput.value = '';
      userInput.focus();

      // پیغام موقت لودینگ
      const loadingNode = appendMessage('در حال دریافت پاسخ' + ' ...', false);
      setLoadingState(true);

      try {
        // آدرس endpoint — چون Flask صفحه را سرو می‌کند، از مسیر نسبی استفاده می‌کنیم
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });

        if (!res.ok) {
          // سعی کن پیام خطا از بدنه بخونی
          let errText = 'خطای سرور';
          try {
            const j = await res.json();
            if (j && j.error) errText = j.error;
          } catch (_) {}
          loadingNode.textContent = errText;
          return;
        }

        const data = await res.json();
        // جایگزین کردن پیام لودینگ با پاسخ نهایی
        loadingNode.remove();
        if (data.reply) {
          appendMessage(data.reply, false);
        } else if (data.error) {
          appendMessage(data.error, false);
        } else {
          appendMessage('پاسخ نامشخص از سرور دریافت شد.', false);
        }

      } catch (err) {
        // خطای شبکه یا دیگر خطاها
        loadingNode.textContent = 'خطا در ارتباط با سرور: ' + (err.message || err);
        console.error('Fetch error:', err);
      } finally {
        setLoadingState(false);
        scrollToBottom();
      }
    }

    // ---- رویدادها ----
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // ---- تست محلی بدون بک‌اند (در صورت نیاز) ----
    // اگر می‌خوای بدون اجرا کردن پایتون تست کنی، خط زیر را uncomment کن:
    // appendMessage("برای تست: اینجا پیام‌های شبیه‌سازی‌شده ظاهر می‌شوند.", false);
  </script>
</body>
</html>
